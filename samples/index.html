<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gastown Dashboard</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'SF Mono', 'Menlo', 'Monaco', 'Consolas', monospace;
    background: #0d1117;
    color: #c9d1d9;
    height: 100vh;
    overflow: hidden;
  }

  .container {
    display: grid;
    grid-template-columns: 260px 1fr;
    height: 100vh;
  }

  /* --- Left panel: agent list --- */
  .sidebar {
    background: #161b22;
    border-right: 1px solid #30363d;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .sidebar-header {
    padding: 16px;
    border-bottom: 1px solid #30363d;
    font-size: 14px;
    font-weight: 600;
    color: #e6edf3;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .sidebar-title {
    font-size: 13px;
    color: #8b949e;
    letter-spacing: 0.4px;
  }

  .agent-list {
    flex: 1;
    overflow-y: auto;
    padding: 8px;
  }

  .agent-card {
    padding: 10px 12px;
    border-radius: 6px;
    cursor: pointer;
    margin-bottom: 4px;
    border: 1px solid transparent;
    transition: background 0.15s, border-color 0.15s;
  }

  .agent-card:hover { background: #1c2128; }
  .agent-card.selected { background: #1c2128; border-color: #58a6ff; }

  .agent-name {
    font-size: 13px;
    font-weight: 600;
    color: #e6edf3;
    display: flex;
    align-items: center;
    gap: 6px;
    flex-wrap: wrap;
    overflow-wrap: anywhere;
  }

  .agent-meta {
    font-size: 11px;
    color: #8b949e;
    margin-top: 4px;
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .badge {
    font-size: 10px;
    padding: 1px 6px;
    border-radius: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .badge-role {
    color: #0d1117;
  }

  .badge-attached {
    background: #1f6feb33;
    color: #58a6ff;
  }

  .badge-runtime {
    color: #8b949e;
  }

  /* Role colors */
  .role-mayor    { background: #da3633; }
  .role-deacon   { background: #a371f7; }
  .role-overseer { background: #58a6ff; }
  .role-witness  { background: #3fb950; }
  .role-refinery { background: #d29922; }
  .role-crew     { background: #f778ba; }
  .role-polecat  { background: #79c0ff; }
  .role-boot     { background: #8b949e; }

  /* --- Right panel: terminal viewer --- */
  .main {
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .main-header {
    padding: 12px 16px;
    border-bottom: 1px solid #30363d;
    font-size: 13px;
    color: #8b949e;
    background: #161b22;
    display: flex;
    align-items: center;
    gap: 8px;
    min-height: 44px;
    flex-wrap: nowrap;
  }

  .header-content {
    display: flex;
    align-items: center;
    gap: 8px;
    flex: 1;
    min-width: 0;
    overflow: hidden;
    white-space: nowrap;
  }

  .main-header .agent-label {
    color: #e6edf3;
    font-weight: 600;
    overflow-wrap: anywhere;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .connection-status {
    margin-left: auto;
    display: flex;
    align-items: center;
    gap: 6px;
    color: #58a6ff;
    font-size: 12px;
    font-weight: 600;
    white-space: nowrap;
    flex-shrink: 0;
  }

  .connection-status .dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #3fb950;
    flex-shrink: 0;
  }

  .connection-status .dot.disconnected { background: #f85149; }

  .output-wrap {
    flex: 1;
    overflow: hidden;
    position: relative;
  }

  .placeholder {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: #484f58;
    font-size: 14px;
  }

  .empty-sidebar {
    padding: 16px;
    color: #484f58;
    font-size: 12px;
    text-align: center;
  }

  .agent-list-state {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    min-height: 56px;
    padding: 12px;
    color: #8b949e;
    font-size: 12px;
    text-align: center;
  }

  .agent-list-state.timeout {
    color: #f0883e;
  }

  .spinner {
    width: 12px;
    height: 12px;
    border: 2px solid #30363d;
    border-top-color: #58a6ff;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    flex-shrink: 0;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .mobile-nav-btn,
  .sidebar-close {
    display: none;
    border: 1px solid #30363d;
    background: #0d1117;
    color: #c9d1d9;
    border-radius: 6px;
    font-size: 18px;
    font-weight: 700;
    line-height: 1;
    width: 32px;
    height: 30px;
    padding: 0;
    cursor: pointer;
  }

  .sidebar-close {
    margin-left: auto;
    font-size: 20px;
  }

  .drawer-backdrop {
    display: none;
  }

  @media (max-width: 900px) {
    .container {
      grid-template-columns: 1fr;
      height: 100vh;
      min-height: 100vh;
    }

    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      bottom: 0;
      width: min(86vw, 340px);
      border-right: 1px solid #30363d;
      border-bottom: 0;
      transform: translateX(-100%);
      transition: transform 0.2s ease;
      z-index: 50;
      box-shadow: 12px 0 28px rgba(0, 0, 0, 0.4);
      min-height: 100vh;
    }

    body.drawer-open .sidebar {
      transform: translateX(0);
    }

    .drawer-backdrop {
      display: block;
      position: fixed;
      inset: 0;
      background: rgba(1, 4, 9, 0.62);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
      z-index: 40;
    }

    body.drawer-open .drawer-backdrop {
      opacity: 1;
      pointer-events: auto;
    }

    .main {
      min-width: 0;
    }

    .sidebar-header {
      padding: 10px 12px;
      font-size: 13px;
      min-height: 40px;
      position: sticky;
      top: 0;
      background: #161b22;
      z-index: 1;
    }

    .sidebar-close {
      margin-left: 0;
      order: -1;
    }

    .sidebar-title {
      margin-left: 4px;
    }

    .agent-list {
      display: block;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 10px;
    }

    .empty-sidebar {
      min-width: 0;
    }

    .agent-card {
      min-width: 0;
      max-width: none;
      margin-bottom: 6px;
    }

    .main-header {
      padding: 10px 12px;
      font-size: 12px;
      min-height: 40px;
      gap: 6px;
    }

    .mobile-nav-btn,
    .sidebar-close {
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .header-content {
      gap: 6px;
    }

    .connection-status {
      font-size: 11px;
      gap: 5px;
    }

    .placeholder {
      padding: 16px;
      text-align: center;
      font-size: 13px;
    }
  }

  @media (max-width: 520px) {
    .agent-card { padding: 9px 10px; }

    .agent-meta {
      font-size: 10px;
      gap: 6px;
    }

    .badge {
      font-size: 9px;
      padding: 1px 5px;
    }
  }
</style>
<script type="importmap">
{ "imports": { "ghostty-web": "https://cdn.jsdelivr.net/npm/ghostty-web/+esm" } }
</script>
</head>
<body>
<div class="container">
  <div class="sidebar">
    <div class="sidebar-header">
      <button type="button" class="sidebar-close" id="sidebar-close" aria-label="Close agents drawer">×</button>
      <span class="sidebar-title">Agents</span>
    </div>
    <div class="agent-list" id="agent-list">
      <div class="agent-list-state"><span class="spinner"></span><span>Loading agents...</span></div>
    </div>
  </div>

  <div class="main">
    <div class="main-header" id="main-header">
      <button type="button" class="mobile-nav-btn" id="mobile-nav-btn" aria-label="Open agents drawer">☰</button>
      <div class="header-content" id="header-content">Select an agent to view output</div>
      <div class="connection-status" id="connection-status">
        <span class="dot disconnected" id="status-dot"></span>
        <span id="status-text">Connecting...</span>
      </div>
    </div>
    <div class="output-wrap" id="output-wrap">
      <div class="placeholder" id="placeholder">Select an agent from the sidebar</div>
    </div>
  </div>
</div>
<div class="drawer-backdrop" id="drawer-backdrop"></div>

<script type="module">
import { init } from 'ghostty-web';
await init();

var adapterHost = new URLSearchParams(location.search).get('adapter') || 'localhost:8080';
var adapterOrigin = (location.protocol === 'https:' ? 'https://' : 'http://') + adapterHost;
var { decodeBinaryFrame, encodeBinaryFrame, BinaryMsgType } = await import(adapterOrigin + '/tmux-adapter-web/index.js');

// --- State ---
var agents = new Map();       // name -> agent object
var selectedAgent = null;     // name of currently selected agent
var msgId = 0;                // monotonic message id
var ws = null;
var textEncoder = new TextEncoder();
var agentsLoading = true;
var agentsLoadTimedOut = false;
var agentsLoadTimer = null;
var AgentsLoadTimeoutMs = 7000;

// --- DOM refs ---
var agentListEl  = document.getElementById('agent-list');
var outputWrapEl = document.getElementById('output-wrap');
var headerContentEl = document.getElementById('header-content');
var placeholderEl = document.getElementById('placeholder');
var statusDot    = document.getElementById('status-dot');
var statusText   = document.getElementById('status-text');
var mobileNavBtn = document.getElementById('mobile-nav-btn');
var sidebarCloseBtn = document.getElementById('sidebar-close');
var drawerBackdropEl = document.getElementById('drawer-backdrop');

// --- Terminal event wiring (delegated on outputWrapEl) ---
outputWrapEl.addEventListener('terminal-input', function(e) {
  sendBinary(BinaryMsgType.KeyboardInput, e.detail.name, e.detail.data);
});

outputWrapEl.addEventListener('terminal-resize', function(e) {
  sendBinary(BinaryMsgType.Resize, e.detail.name, textEncoder.encode(e.detail.cols + ':' + e.detail.rows));
});

outputWrapEl.addEventListener('file-upload', function(e) {
  sendBinary(BinaryMsgType.FileUpload, e.detail.name, e.detail.payload);
});

// --- Helpers ---
function createBadge(text, classNames) {
  var el = document.createElement('span');
  el.textContent = text;
  el.className = classNames;
  return el;
}

function clearChildren(el) {
  while (el.firstChild) el.removeChild(el.firstChild);
}

function clearAgentsLoadTimer() {
  if (!agentsLoadTimer) return;
  clearTimeout(agentsLoadTimer);
  agentsLoadTimer = null;
}

function startAgentsLoading() {
  agentsLoading = true;
  agentsLoadTimedOut = false;
  clearAgentsLoadTimer();
  agentsLoadTimer = setTimeout(function() {
    if (!agentsLoading) return;
    agentsLoading = false;
    agentsLoadTimedOut = true;
    renderAgentList();
  }, AgentsLoadTimeoutMs);
  renderAgentList();
}

function markAgentsLoaded() {
  agentsLoading = false;
  agentsLoadTimedOut = false;
  clearAgentsLoadTimer();
}

function sendResizeNow(agentName) {
  var el = outputWrapEl.querySelector('tmux-adapter-web[name="' + CSS.escape(agentName) + '"]');
  if (!el || !el.cols || !el.rows) return false;
  var payload = textEncoder.encode(el.cols + ':' + el.rows);
  sendBinary(BinaryMsgType.Resize, agentName, payload);
  return true;
}

function subscribeOutputWithSizedSnapshot(agentName) {
  if (!agentName) return;

  requestAnimationFrame(function() {
    sendResizeNow(agentName);
    send({ type: 'subscribe-output', agent: agentName });
  });
}

function isMobileLayout() {
  return window.matchMedia('(max-width: 900px)').matches;
}

function openDrawer() {
  if (!isMobileLayout()) return;
  document.body.classList.add('drawer-open');
}

function closeDrawer() {
  document.body.classList.remove('drawer-open');
}

function syncMobileNavButton() {
  if (!mobileNavBtn) return;
  mobileNavBtn.textContent = '☰';
  mobileNavBtn.setAttribute('aria-label', 'Open agents drawer');
}

function bindMobileLayoutEvents() {
  if (mobileNavBtn) {
    mobileNavBtn.addEventListener('click', function() {
      if (!isMobileLayout()) return;
      openDrawer();
    });
  }

  if (sidebarCloseBtn) {
    sidebarCloseBtn.addEventListener('click', function() {
      closeDrawer();
    });
  }

  if (drawerBackdropEl) {
    drawerBackdropEl.addEventListener('click', function() {
      closeDrawer();
    });
  }

  var media = window.matchMedia('(max-width: 900px)');
  var onChange = function(ev) {
    if (!ev.matches) {
      closeDrawer();
    } else if (!selectedAgent) {
      openDrawer();
    }
    syncMobileNavButton();
  };
  if (typeof media.addEventListener === 'function') {
    media.addEventListener('change', onChange);
  } else if (typeof media.addListener === 'function') {
    media.addListener(onChange);
  }
}

// --- Binary protocol ---
function sendBinary(type, agentName, payload) {
  if (!ws || ws.readyState !== WebSocket.OPEN) return;
  ws.send(encodeBinaryFrame(type, agentName, payload));
}

function handleBinaryMessage(buffer) {
  var parsed = decodeBinaryFrame(buffer);
  var el = outputWrapEl.querySelector('tmux-adapter-web[name="' + CSS.escape(parsed.agentName) + '"]');
  if (!el) return;
  if (parsed.msgType === BinaryMsgType.TerminalSnapshot) el.reset();
  if (parsed.msgType === BinaryMsgType.TerminalOutput || parsed.msgType === BinaryMsgType.TerminalSnapshot) {
    el.write(parsed.payload);
  }
}

// --- Terminal management ---
function showTerminal(agentName) {
  outputWrapEl.querySelectorAll('tmux-adapter-web').forEach(function(el) {
    el.style.display = 'none';
  });

  var el = outputWrapEl.querySelector('tmux-adapter-web[name="' + CSS.escape(agentName) + '"]');
  if (!el) {
    el = document.createElement('tmux-adapter-web');
    el.setAttribute('name', agentName);
    outputWrapEl.appendChild(el);
  }
  el.style.display = '';
  placeholderEl.style.display = 'none';

  requestAnimationFrame(function() { el.focus(); });
}

function hideAllTerminals() {
  outputWrapEl.querySelectorAll('tmux-adapter-web').forEach(function(el) {
    el.style.display = 'none';
  });
  placeholderEl.style.display = '';
}

// --- WebSocket ---
function connect() {
  var proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  var wsURL = new URL(proto + '//' + adapterHost + '/ws');
  var token = new URLSearchParams(location.search).get('token');
  if (token) {
    wsURL.searchParams.set('token', token);
  }
  ws = new WebSocket(wsURL.toString());
  ws.binaryType = 'arraybuffer';

  ws.onopen = function() {
    statusDot.classList.remove('disconnected');
    statusText.textContent = 'Connected';
    if (agents.size === 0) {
      startAgentsLoading();
    }
    send({ type: 'subscribe-agents' });

    // Re-subscribe to selected agent's output on reconnect
    if (selectedAgent) {
      var el = outputWrapEl.querySelector('tmux-adapter-web[name="' + CSS.escape(selectedAgent) + '"]');
      if (el) el.reset();
      showTerminal(selectedAgent);
      subscribeOutputWithSizedSnapshot(selectedAgent);
    }
  };

  ws.onclose = function() {
    statusDot.classList.add('disconnected');
    statusText.textContent = 'Disconnected';
    if (agents.size === 0) {
      startAgentsLoading();
    }
    setTimeout(connect, 2000);
  };

  ws.onmessage = function(ev) {
    if (typeof ev.data === 'string') {
      handleJsonMessage(JSON.parse(ev.data));
    } else if (ev.data instanceof ArrayBuffer) {
      handleBinaryMessage(ev.data);
    }
  };
}

function send(obj) {
  if (!ws || ws.readyState !== WebSocket.OPEN) return null;
  obj.id = String(++msgId);
  ws.send(JSON.stringify(obj));
  return obj.id;
}

// --- JSON message handling ---
function handleJsonMessage(msg) {
  switch (msg.type) {
    case 'subscribe-agents':
      agents.clear();
      if (msg.agents) msg.agents.forEach(function(a) { agents.set(a.name, a); });
      markAgentsLoaded();
      renderAgentList();
      break;

    case 'agent-added':
      if (msg.agent) agents.set(msg.agent.name, msg.agent);
      renderAgentList();
      break;

    case 'agent-removed':
      var removedName = msg.name || (msg.agent && msg.agent.name);
      if (removedName) {
        agents.delete(removedName);
        var el = outputWrapEl.querySelector('tmux-adapter-web[name="' + CSS.escape(removedName) + '"]');
        if (el) el.remove(); // disconnectedCallback handles cleanup
        if (selectedAgent === removedName) deselectAgent();
      }
      renderAgentList();
      break;

    case 'agent-updated':
      if (msg.agent) agents.set(msg.agent.name, msg.agent);
      renderAgentList();
      if (msg.agent && msg.agent.name === selectedAgent) updateHeader();
      break;

    case 'subscribe-output':
      break;

    case 'send-prompt':
      break;

    case 'error':
      console.error('ws error:', msg.error || msg);
      break;
  }
}

// --- Agent list rendering (safe DOM methods) ---
function renderAgentList() {
  clearChildren(agentListEl);

  if (agentsLoading) {
    var loading = document.createElement('div');
    loading.className = 'agent-list-state';
    var spinner = document.createElement('span');
    spinner.className = 'spinner';
    loading.appendChild(spinner);
    var loadingText = document.createElement('span');
    loadingText.textContent = 'Loading agents...';
    loading.appendChild(loadingText);
    agentListEl.appendChild(loading);
    return;
  }

  if (agents.size === 0) {
    var empty = document.createElement('div');
    empty.className = 'agent-list-state' + (agentsLoadTimedOut ? ' timeout' : '');
    empty.textContent = agentsLoadTimedOut ? 'Agent list load timed out' : 'No agents running';
    agentListEl.appendChild(empty);
    return;
  }

  var sorted = Array.from(agents.values()).sort(function(a, b) {
    return a.name.localeCompare(b.name);
  });

  sorted.forEach(function(agent) {
    var card = document.createElement('div');
    card.className = 'agent-card' + (agent.name === selectedAgent ? ' selected' : '');
    card.addEventListener('click', function() { selectAgent(agent.name); });

    // Name row
    var nameRow = document.createElement('div');
    nameRow.className = 'agent-name';
    nameRow.appendChild(createBadge(agent.role || '?', 'badge badge-role role-' + (agent.role || 'boot')));
    var nameSpan = document.createElement('span');
    nameSpan.textContent = agent.name;
    nameRow.appendChild(nameSpan);
    card.appendChild(nameRow);

    // Meta row
    var metaRow = document.createElement('div');
    metaRow.className = 'agent-meta';
    metaRow.appendChild(createBadge(agent.runtime || '?', 'badge-runtime'));
    if (agent.attached) {
      metaRow.appendChild(createBadge('attached', 'badge badge-attached'));
    }
    card.appendChild(metaRow);

    agentListEl.appendChild(card);
  });
}

// --- Agent selection ---
function selectAgent(name) {
  if (selectedAgent === name) {
    if (isMobileLayout()) {
      closeDrawer();
    }
    syncMobileNavButton();
    return;
  }

  // Unsubscribe from previous
  if (selectedAgent) {
    send({ type: 'unsubscribe-output', agent: selectedAgent });
  }

  selectedAgent = name;

  // Reset terminal for fresh snapshot on re-select
  var el = outputWrapEl.querySelector('tmux-adapter-web[name="' + CSS.escape(name) + '"]');
  if (el) el.reset();

  updateHeader();
  renderAgentList();

  showTerminal(name);
  subscribeOutputWithSizedSnapshot(name);

  if (isMobileLayout()) {
    closeDrawer();
  }
  syncMobileNavButton();
}

function deselectAgent() {
  selectedAgent = null;
  hideAllTerminals();

  clearChildren(headerContentEl);
  headerContentEl.textContent = 'Select an agent to view output';

  renderAgentList();
  if (isMobileLayout()) {
    openDrawer();
  }
  syncMobileNavButton();
}

function updateHeader() {
  if (!selectedAgent) return;
  var agent = agents.get(selectedAgent);
  if (!agent) return;

  clearChildren(headerContentEl);
  headerContentEl.appendChild(createBadge(agent.role || '?', 'badge badge-role role-' + (agent.role || 'boot')));

  var label = document.createElement('span');
  label.className = 'agent-label';
  label.textContent = agent.name;
  headerContentEl.appendChild(label);

  headerContentEl.appendChild(createBadge(agent.runtime || '?', 'badge-runtime'));

  if (agent.attached) {
    headerContentEl.appendChild(createBadge('attached', 'badge badge-attached'));
  }

  syncMobileNavButton();
}

// --- Boot ---
bindMobileLayoutEvents();
startAgentsLoading();
connect();
syncMobileNavButton();
if (isMobileLayout() && !selectedAgent) {
  openDrawer();
}
</script>
</body>
</html>
